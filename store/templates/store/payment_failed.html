{% extends 'store/main.html' %}
{% load static %}
{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="box-element text-center">
                <div class="text-danger mb-4">
                    <i class="fas fa-times-circle" style="font-size: 4rem;"></i>
                </div>
                <h2 class="text-danger">Payment Failed</h2>
                <p class="lead">We're sorry, but your payment could not be processed.</p>
                
                {% if mpesa_transaction %}
                <div class="alert alert-warning">
                    <strong>Transaction Status:</strong> {{ mpesa_transaction.get_status_display }}<br>
                    {% if mpesa_transaction.result_desc %}
                    <strong>Reason:</strong> {{ mpesa_transaction.result_desc }}<br>
                    {% endif %}
                    <strong>Transaction ID:</strong> {{ mpesa_transaction.checkout_request_id }}
                </div>
                {% endif %}
            </div>
            
            <div class="box-element">
                <h4>Order Details</h4>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Order ID:</strong> #{{ order.id }}</p>
                        <p><strong>Date:</strong> {{ order.date_ordered|date:"M d, Y H:i" }}</p>
                        <p><strong>Payment Method:</strong> {{ order.get_payment_method_display }}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge badge-warning">{{ order.get_payment_status_display }}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total Items:</strong> {{ order.get_cart_items }}</p>
                        <p><strong>Total Amount:</strong> KSh {{ order.get_cart_total|floatformat:2 }}</p>
                    </div>
                </div>
                
                <h5 class="mt-4">Items in Your Order:</h5>
                <hr>
                {% for item in items %}
                <div class="cart-row">
                    <div style="flex:2">
                        <img class="row-image" src="{{ item.product.imageURL }}" alt="{{ item.product.name }}">
                    </div>
                    <div style="flex:3">
                        <p><strong>{{ item.product.name }}</strong></p>
                        <p class="text-muted">{{ item.product.description|truncatewords:10 }}</p>
                    </div>
                    <div style="flex:1">
                        <p>KSh {{ item.product.price }}</p>
                    </div>
                    <div style="flex:1">
                        <p>Qty: {{ item.quantity }}</p>
                    </div>
                    <div style="flex:1">
                        <p><strong>KSh {{ item.get_total|floatformat:2 }}</strong></p>
                    </div>
                </div>
                {% endfor %}
                
                <div class="text-right mt-3">
                    <h5><strong>Total: KSh {{ order.get_cart_total|floatformat:2 }}</strong></h5>
                </div>
            </div>
            
            <div class="box-element">
                <h5>What Can You Do?</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-redo text-primary" style="font-size: 2rem;"></i>
                                <h6 class="card-title mt-3">Try Again</h6>
                                <p class="card-text">Retry your Mpesa payment</p>
                                <a href="{% url 'checkout' %}" class="btn btn-primary">Retry Payment</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-credit-card text-success" style="font-size: 2rem;"></i>
                                <h6 class="card-title mt-3">Different Method</h6>
                                <p class="card-text">Choose Cash on Delivery</p>
                                <a href="{% url 'checkout' %}" class="btn btn-success">Change Method</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Common Issues & Solutions:</h6>
                    <ul class="mb-0">
                        <li><strong>Insufficient funds:</strong> Please ensure you have enough balance in your Mpesa account</li>
                        <li><strong>Wrong PIN:</strong> Make sure you enter the correct Mpesa PIN</li>
                        <li><strong>Network issues:</strong> Check your network connection and try again</li>
                        <li><strong>Transaction timeout:</strong> The payment request may have expired, please try again</li>
                    </ul>
                </div>
                
                <div class="text-center mt-4">
                    <a href="{% url 'checkout' %}" class="btn btn-primary mr-3">Try Again</a>
                    <a href="{% url 'cart' %}" class="btn btn-outline-secondary mr-3">Back to Cart</a>
                    <a href="{% url 'store' %}" class="btn btn-outline-primary">Continue Shopping</a>
                </div>
            </div>
            
            <div class="box-element">
                <h6>Need Help?</h6>
                <p>If you continue to experience issues, please contact our support team:</p>
                <ul class="list-unstyled">
                    <li><i class="fas fa-phone text-primary"></i> Phone: +254 700 000 000</li>
                    <li><i class="fas fa-envelope text-primary"></i> Email: support@yourstore.com</li>
                    <li><i class="fas fa-clock text-primary"></i> Hours: Mon-Fri 8AM-6PM</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock content %}